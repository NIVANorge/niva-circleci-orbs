version: "2.1"
description: "an orb used by NIVA projects to test code and publish code to a k8s cluster in the google cloud"

executors:
  google-sdk-container:
    docker:
      - image: google/cloud-sdk:237.0.0

commands:
  setup_nivatest:
    description: "A command to configure google cloud to use the nivatest-environment"
    steps:
      - run:
          name: "Setup nivatest"
          command: |
            set -o nounset
            echo $NIVATEST_SERVICE_KEY | base64 --decode --ignore-garbage > gcloud-service-key.json
            set -x
            echo 'export SHORT_GIT_HASH=$(git rev-parse --short $CIRCLE_SHA1)' >> $BASH_ENV
            echo 'export REPONAME=$(echo "github-$CIRCLE_PROJECT_USERNAME-$CIRCLE_PROJECT_REPONAME" | tr '[:upper:]' '[:lower:]')' >> $BASH_ENV
            echo 'export CONTAINER_REGISTRY=eu.gcr.io/$NIVATEST_PROJECT_NAME/$REPONAME' >> $BASH_ENV
  setup_nivaprod:
    description: "A command to configure google cloud to use the nivatest-environment"
    steps:
      - run:
          name: "Setup nivaprod"
          command: |
            set -o nounset
            echo $NIVAPROD_SERVICE_KEY | base64 --decode --ignore-garbage > gcloud-service-key.json
            set -x
            echo 'export SHORT_GIT_HASH=$(git rev-parse --short $CIRCLE_SHA1)' >> $BASH_ENV
            echo 'export REPONAME=$(echo "github-$CIRCLE_PROJECT_USERNAME-$CIRCLE_PROJECT_REPONAME" | tr '[:upper:]' '[:lower:]')' >> $BASH_ENV
            echo 'export CONTAINER_REGISTRY=eu.gcr.io/$NIVAPROD_PROJECT_NAME/$REPONAME' >> $BASH_ENV
  pull_containers:
    description: "A command to build containers, it expects one file in the workspace: requested_containers. This file
    should have a container name on each line"
    parameters:
      container-registry:
        type: env_var_name
        default: CONTAINER_REGISTRY
      gcloud-json-token:
        type: string
        default: "gcloud-service-key.json"
      tag:
        type: string
        default: "latest"
    steps:
      - run:
          name: "Retrieve cached images"
          command: |
            set -x
            set -o nounset
            gcloud auth activate-service-account --key-file << parameters.gcloud-json-token >>
            gcloud --quiet auth configure-docker
            cat workspace/requested_containers | while read container; do
              if gcloud container images list-tags "${<< parameters.container-registry >>}-$container" | grep latest; then
                docker pull "${<< parameters.container-registry >>}-$container:<< parameters.tag >>" | grep -e 'Pulling from' -e Digest -e Status -e Error
              fi
            done
  build_containers:
    description: "A command to build containers, it expects three files in the workspace: requested_containers,
    image_names and docker_directories. It also expects the $CONTAINER_REGISTRY and $SHORT_GIT_HASH to be set."
    steps:
      - setup_nivatest
      - pull_containers
      - run:
          name: "Build new images"
          command: |
            set -x
            set -o nounset
            source workspace/image_names
            source workspace/docker_directories
            mkdir docker-cache
            :>sed_subber
            cat workspace/requested_containers | while read container; do
              echo "Building: $container from directory: ${docker_directories[$container]}"
              if docker images -q "$CONTAINER_REGISTRY-$container:latest" | grep -E .+; then
                docker build --cache-from "$CONTAINER_REGISTRY-$container:latest" \
                --tag "$CONTAINER_REGISTRY-$container:$SHORT_GIT_HASH" \
                --tag "$CONTAINER_REGISTRY-$container:latest" ${docker_directories[$container]} | cat
              else
                docker build --tag "$CONTAINER_REGISTRY-$container:$SHORT_GIT_HASH" \
                --tag "$CONTAINER_REGISTRY-$container:latest" ${docker_directories[$container]} | cat
              fi
              echo "s|${image_names[$container]}|$CONTAINER_REGISTRY-$container:$SHORT_GIT_HASH|g" >> sed_subber
            done
  push_containers:
    description: "A command to push containers, it expects one file in the workspace: requested_containers"
    parameters:
      container-registry:
        type: env_var_name
        default: CONTAINER_REGISTRY
      gcloud-json-token:
        type: string
        default: "gcloud-service-key.json"
    steps:
      - run:
          name: "Push images"
          command: |
            set -x
            set -o nounset
            gcloud auth activate-service-account --key-file << parameters.gcloud-json-token >>
            gcloud --quiet auth configure-docker
            cat workspace/requested_containers | while read container; do
              docker push "${<< parameters.container-registry >>}-$container:$SHORT_GIT_HASH" | grep -e repository -e digest -e Error
              docker push "${<< parameters.container-registry >>}-$container:latest" | grep -e repository -e digest -e Error
            done
  deploy_to_k8s:
    description: "A deployment command that can deploy kubernetes deployments to a cluster in a google project. It
    requires three files to be present in the workspace: kubectl_deployment_directories, requested_containers and sed_subber"
    parameters:
      project:
        type: string
      cluster:
        type: string
    steps:
      - run:
          name: Deploy
          command: |
            set -x
            set -o nounset
            gcloud auth activate-service-account --key-file gcloud-service-key.json
            gcloud --quiet config set project << parameters.project >>
            gcloud --quiet config set compute/zone $GCLOUD_COMPUTE_ZONE
            gcloud --quiet container clusters get-credentials << parameters.cluster >>
            kubectl apply -f k8s/config/<< parameters.project >>/nivacloud-config-map.yaml
            source workspace/kubectl_deployment_directories
            :> new_deployments
            perl_regexp_k8s_name_pattern='metadata:\n\s*name:\s*\K(\w*\-*\w*\s*\n)'
            cat workspace/requested_containers | while read container; do
              find ${kubectl_deployment_directories[$container]} -type f -name '*.tmpl.yaml' | while read line; do
                if grep -E "^kind:\s*Job\s*$" $line; then
                  jobname=$(grep -Pzo $perl_regexp_k8s_name_pattern $line)
                  if kubectl get jobs | grep "$jobname"; then
                    kubectl delete jobs/"$jobname"
                  fi
                fi
                cat $line | sed -f workspace/sed_subber | kubectl apply -f -
                (grep -Pzo "kind:\s*Deployment\s*\n\s*$perl_regexp_k8s_name_pattern" $line || true) >> new_deployments
              done
            done
            cat new_deployments | while read deployment_name; do
              deployment_namespace=$(kubectl get deployment --all-namespaces | grep -oP "\w*(?=\s*$deployment_name)")
              kubectl --namespace="$deployment_namespace" rollout status deployment "$deployment_name"
            done